name: Deploy to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1) Get latest code from GitHub
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) Install and start MongoDB
      - name: Install and start MongoDB
        run: |
          if ! command -v mongod >/dev/null 2>&1; then
            echo "MongoDB not found. Installing MongoDB..."

            if [ ! -f /usr/share/keyrings/mongodb-server-8.0.gpg ]; then
              curl -fsSL https://pgp.mongodb.com/server-8.0.asc | \
                sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
            fi

            if [ ! -f /etc/apt/sources.list.d/mongodb-org-8.0.list ]; then
              echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse" | \
                sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
            fi

            sudo apt-get update
            sudo apt-get install -y mongodb-org
          else
            echo "MongoDB already installed, skipping installation."
          fi

          sudo systemctl enable mongod
          sudo systemctl start mongod
          sudo systemctl status mongod --no-pager || true

      # 3) Build Docker image for Flask app
      - name: Build Docker image
        run: |
          sudo docker build -t flask-ci-cd-app:latest .

      # 4) Stop and remove existing container if running
      - name: Stop and remove old container
        run: |
          if [ "$(sudo docker ps -q -f name=flask-ci-cd-container)" ]; then
            sudo docker stop flask-ci-cd-container
            sudo docker rm flask-ci-cd-container
          elif [ "$(sudo docker ps -aq -f status=exited -f name=flask-ci-cd-container)" ]; then
            sudo docker rm flask-ci-cd-container
          fi

      # 5) Run new container (host network so MongoDB at localhost works)
      - name: Run new container
        run: |
          sudo docker run -d \
            --name flask-ci-cd-container \
            --network host \
            flask-ci-cd-app:latest

      # 6) Verify the app + MongoDB response
      - name: Verify Flask + MongoDB response
        run: |
          sleep 5
          RESPONSE=$(curl -s http://127.0.0.1:5000/)
          echo "Response from app: $RESPONSE"
          if [[ "$RESPONSE" != *"MongoDB server is successfully installed"* ]]; then
            echo "Expected MongoDB success message not found!"
            exit 1
          fi
          echo "MongoDB check passed and app responded correctly."
